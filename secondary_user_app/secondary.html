<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>S.A.U.C.E Secondary Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>
    #map { height: 400px; }
    #popupAlert {
      position: fixed;
      top: 20px; right: 20px;
      background: rgba(220,38,38,0.95);
      color: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
    }
    .status-badge { padding: 6px 14px; border-radius: 9999px; font-weight: 500; }
    .safe { background-color: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.4); }
    .panic { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.4); }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col">

  <!-- Main Content -->
  <main class="flex-grow p-6">
    <h1 class="text-3xl font-semibold">üì≤ Secondary User Dashboard</h1>
    <p class="mt-1 text-slate-400">Receive alerts and assist nearby users</p>

    <!-- Status -->
    <div class="mt-4">
      <span id="alertMsg" class="status-badge safe">No active alerts</span>
    </div>

    <!-- Map -->
    <div class="mt-6 card rounded-xl overflow-hidden shadow-lg border border-slate-700">
      <div class="bg-slate-800 px-4 py-2 border-b border-slate-700">
        <h2 class="text-lg font-medium">üìç Live Map</h2>
      </div>
      <div id="map"></div>
    </div>
  </main>

  <!-- Popup Notification -->
  <div id="popupAlert">
    <p id="popupText" class="font-semibold">üö® Primary user needs help!</p>
    <div class="mt-2 flex gap-2">
      <button id="approve" class="px-3 py-1 bg-green-600 rounded">‚úÖ Approve</button>
      <button id="decline" class="px-3 py-1 bg-gray-600 rounded">‚ùå Decline</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-slate-800 text-slate-400 text-center text-sm py-4 border-t border-slate-700">
    ¬© 2025 S.A.U.C.E ‚Äî Send Assistance Upon Critical Emergencies ‚Ä¢ Team AlertX
  </footer>

  <!-- Alert Sound -->
  <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([20.59, 78.96], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);

    let marker;
    let lastAlert = null;

    async function checkAlerts() {
      let res = await fetch("http://localhost:3000/users");
      let data = await res.json();
      let panicUser = data.users.find(u => u.status === "panic");

      if (panicUser && panicUser.username !== lastAlert) {
        // Update status badge
        let badge = document.getElementById("alertMsg");
        badge.textContent = panicUser.username + " needs help!";
        badge.classList.remove("safe");
        badge.classList.add("panic");

        // Popup
        document.getElementById("popupText").textContent = "üö® " + panicUser.username + " needs help!";
        document.getElementById("popupAlert").style.display = "block";

        // Sound + vibration
        document.getElementById("alertSound").play();
        if (navigator.vibrate) navigator.vibrate([300,200,300]);

        // Map marker
        if (!marker) marker = L.marker([panicUser.lat, panicUser.lng]).addTo(map);
        marker.setLatLng([panicUser.lat, panicUser.lng]).bindPopup("Help needed!").openPopup();
        map.setView([panicUser.lat, panicUser.lng], 14);

        // Approve ‚Üí Google Maps navigation
        document.getElementById("approve").onclick = () =>
          window.open(`https://www.google.com/maps/dir/?api=1&destination=${panicUser.lat},${panicUser.lng}`);

        // Decline ‚Üí hide popup
        document.getElementById("decline").onclick = () =>
          document.getElementById("popupAlert").style.display = "none";

        lastAlert = panicUser.username;
      }

      if (!panicUser) {
        let badge = document.getElementById("alertMsg");
        badge.textContent = "No active alerts";
        badge.classList.remove("panic");
        badge.classList.add("safe");
        document.getElementById("popupAlert").style.display = "none";
        lastAlert = null;
      }
    }

    setInterval(checkAlerts, 3000);
  </script>
</body>
</html>
