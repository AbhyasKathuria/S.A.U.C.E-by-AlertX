<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>S.A.U.C.E Police Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>
    #map { height: 400px; }
    .status-badge { padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .safe { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.4); }
    .panic { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.4); }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col">

  <!-- Main Content -->
  <main class="flex-grow p-6">
    <h1 class="text-3xl font-bold text-indigo-400">🚓 Police Control Center</h1>
    <p class="mt-1 text-slate-400">Live emergency monitoring of all registered users</p>

    <!-- User List -->
    <div class="mt-6 card rounded-xl shadow-lg border border-slate-700 overflow-hidden">
      <div class="bg-slate-800 px-4 py-2 border-b border-slate-700">
        <h2 class="text-lg font-medium">👥 Registered Users</h2>
      </div>
      <div id="usersList" class="p-4 grid gap-3"></div>
    </div>

    <!-- Map -->
    <div class="mt-6 card rounded-xl shadow-lg border border-slate-700 overflow-hidden">
      <div class="bg-slate-800 px-4 py-2 border-b border-slate-700">
        <h2 class="text-lg font-medium">📍 Live Location Map</h2>
      </div>
      <div id="map"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-slate-800 text-slate-400 text-center text-sm py-4 border-t border-slate-700">
    © 2025 S.A.U.C.E — Send Assistance Upon Critical Emergencies • Team AlertX
  </footer>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([20.59, 78.96], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
    let markers = {};

    async function updateDashboard() {
      let res = await fetch("http://localhost:3000/users");
      let data = await res.json();
      let list = document.getElementById("usersList");
      list.innerHTML = "";

      // Sort panic users to the top
      let sorted = [...data.users].sort((a,b)=>{
        if(a.status==="panic" && b.status!=="panic") return -1;
        if(b.status==="panic" && a.status!=="panic") return 1;
        return 0;
      });

      sorted.forEach(u => {
        let div = document.createElement("div");
        div.className = "p-4 rounded flex justify-between items-center " +
                        (u.status==="panic" ? "bg-red-600/20 border border-red-500/40" : "bg-green-600/10 border border-green-500/30");

        div.innerHTML = `
          <div>
            <p class="font-bold text-lg">${u.username}</p>
            <p>Status: <span class="status-badge ${u.status==='panic'?'panic':'safe'}">${u.status.toUpperCase()}</span></p>
            <p class="text-xs text-slate-300">Lat: ${u.lat.toFixed(3)} • Lng: ${u.lng.toFixed(3)}</p>
          </div>
          <button onclick="focusOnUser(${u.lat},${u.lng},'${u.username}')" class="px-3 py-1 bg-indigo-600 rounded hover:bg-indigo-500">📍 Focus</button>
        `;
        list.appendChild(div);

        if (!markers[u.username]) markers[u.username] = L.marker([u.lat, u.lng]).addTo(map);
        markers[u.username].setLatLng([u.lat, u.lng]).bindPopup(u.username+" — "+u.status.toUpperCase());
      });
    }

    function focusOnUser(lat,lng,user) {
      map.setView([lat, lng], 15);
      if (markers[user]) markers[user].openPopup();
    }

    setInterval(updateDashboard, 3000);
  </script>
  
</body>
</html>
